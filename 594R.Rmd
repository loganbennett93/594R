--- 
title: "UVX Headway Distribution"
author: "Logan Bennett"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
description: "This is the book written for my 584R project."
---

<!--chapter:end:index.Rmd-->

# Introduction

Bus Rapid Transit (BRT) systems make use of traffic signal prioritization and preemption (TSP) to increase system reliability, or the consistency with which these systems maintain established schedules. Studies have been done to determine the effects of prioritization on reliability, but less has been done to evaluate the effectiveness of changes to TSP on headway distributions. The UVX BRT system is a fairly new transit network in Utah County. This system makes use of signal prioritization not to maintain a set schedule of arrivals and departures, but rather to achieve consistent headways, or times between the arrivals of buses. What are the effects of variable signal prioritization to the headway distribution of this fleet of buses? Can altering signal priority timing affect the distribution of headway times, leading to more uniformity in arrivals? I plan to use a dataset of UVX arrival data provided by Utah Transit Authority (UTA) to evaluate the effects of signal priority on headways. I will then perform statistical analyses on the dataset to verify what if any of these changes are significant in achieving improved distributions.

<!--chapter:end:01-intro.Rmd-->

# Literature

Bus Rapid Transit (BRT) systems are increasingly used by cities around the world due to their ability to address high passenger demand without exorbitant upfront costs. The cost savings come from the fact that BRTs operate on Right-of-Way category B (ROW-B) facilities with separated designated lanes that are subject to traffic control at intersections. In this way, buses have an unimpeded corridor on which to complete trips. However, the subjection to traffic control creates variability in the operating times of these systems, and several strategies have been developed and implemented to increase their reliability and operating times.One such strategy is the use of Transit Signal Priority (TSP), which alters priority at signalized intersections to provide for reduced running times between stops and a more even distribution of headways. In general, TSP seeks to improve operations by increasing the efficiency with which buses navigate signalized intersections, but it can be distinguished by a few classes (@DELGADO201528):  

  1.Active or passive priority. Active priority involves timing adjustments made
  according to real-time data. Passive priority involves offline measures, such
  as optimized cycle lengths, based off of historical data.

  2.Total, partial, or relative priority. In total priority, control actions such
  as phase jumping, phase insertion, green extension, or early termination of
  the red seek to create zero delay for buses. Partial priority limits control
  actions to those that provide less interruptions to other traffic, such as
  green extensions and early termination of the red. In relative priority, buses
  compete with general traffic at lights for priority.

  3.Unconditional or conditional priority. Unconditional priority means buses
  receive priority at all times whereas conditional priority only provides buses
  with needed control measures when the buses are late.

Adaptive signal priority involves real-time control adjustments made in order to optimize the throughput of both buses and general traffic,in which the delay of each is considered and a controller decides on a response most pertinent to the current traffic conditions. @NI20201 compares adaptive signal priority with active and passive priority, whereas @ALDEEK2017227 groups it with unconditional and conditional priority.  

Many studies have been done to determine the effects of various TSP strategies and configurations. In general, TSP strategies have been found to improve performance of transit systems such as BRT in a number of ways, including reduced delay, improved reliability, and mitigated effects on general traffic.  

@ISHAQ2020946 used a set of trip data from a BRT system in Haifa, Israel to study the relation between service reliability, fleet management, and service utilization. They found that full and unconditional traffic signal priority given at all signals led to an 18% reduction in total vehicle trip time and contributed to a 60% reduction in the standard deviation of trip time. Similarly, @ALDEEK2017227 found that compared to several other TSP strategies, BRT with unconditional TSP provided the best travel time, speed, number of stops, and delay enhancements but resulted in significant crossing street delays, especially at major intersections with high traffic demand. While the unconditionalTSP strategy was found effective in termsof the delay of the BRT system, concerns rise over the effects on side-street traffic if unconditional priority consistently gives right of way to the buses. @Liu2018 clarified that “signal priorities are provided more efficiently and on a more informed basis, with fewer impacts on other traffic operations than the use of unconditional TSP.”The implementation of unconditional TSP may only be practical where crossing street volumes are low, and must reasonably be done in conjunction with studies of how non-transit traffic is effected, as each system’s corridors have differing needs based off of demand and geometry.  

@Liu2018 performed a study using transit operation data from a bus route found in Salt Lake County, Utah. A microscopic simulation was used to test GPS-based TSP scenarios. GPS-based TSP uses a GPS to achieve real-time (active) bus locating and advanced wireless communication technologies to achieve comprehensive analysis of operating information. Then a data-driven optimization method was implemented to understand the effects of flexible granting of signal priority across several models. They found that overall, BRT travel time decreased in all models where TSP was employed when compared to the base BRT model. @ALDEEK2017227 also used simulation models to compare several scenarios. Using field data from a corridor in Orlando, Florida, they found that BRT with conditional TSP that was engaged when the buses were 3 minutes behind experienced significantly improved travel times, average speed, and average total delay per vehicle, with minor effects on crossing street delays, when compared with BRT systems with no TSP or 5-minute conditional thresholds.These results indicate that TSP methods are effective in reducing delay. However, they ignore the important aspect of system reliability, which is critical to improving running times and maintaining ridership.  

@YANG20151 performed a study of a pre-detective TSP strategy for BRT with active priority coordination between primary and secondary intersections using data from Changzhou, China. Using microscopic simulation, they tested three scenarios (traditional TSP, pre-detective TSP, and pre-detective TSP with coordination) against a no TSP base scenario. They found that pre-detective signal priority with coordination was most effective, with bus intersection delay decreasing by 67.4% and headway adherence improving by about 40% when compared with a no TSP strategy, while reducing normal traffic delay.  

@DELGADO201528 studied station and interstation control jointly to determine an optimal control strategy for a single-service transit corridor applied to a high-frequency transit system, with the goal of evaluating effects over the whole corridor. A strategy of green extension with holding buses at stops was shown to produce a greater reduction in waiting times for users, as well as reducing variability and improving headway adherence.  

@NI20201 performed a study of passive TSP control for a BRT system in Taichung, Taiwan. Microsimulation incorporated with a genetic algorithm was developed to coordinate signal offsets along an arterial with BRT operations, with the purpose of balancing improvements in BRT system delays and changes to LOS of other traffic. They found that passive TSP control can reduce approximately 22% of transit delay, with the smallest delay experienced in conjunction with a strategy of a three-minute scheduled headway. Additionally, the 3-minute departure headway scenario exhibited the best service reliability among the scenarios, with a headway stability near 100%.  

These studies indicate the need to view BRT system performance in terms of both system delay and reliability. Especially when viewed across an entire system, it is possible for running times to remain consistent while reliability of individual buses is low. In particular, a bunching phenomenon may occur from a positive feedback loop of fluctuations in passenger demand and traffic conditions (@DELGADO201528).In scenarios where bunching is a problem, it may not be sufficient to base control strategies off of a schedule, rather on reliable operations. This may prove difficult in implementation. For instance, @ISHAQ2020946 noted that the procurement agreement between the public transport authority in Israel and the incumbent operator implies that a schedule-based control strategy is required, as opposed to a headway-based (reliability-based) control strategy. However, when TSP control strategies are reliability-based, measures of reliability increase and the bunching phenomenon can be reduced.

@CATS2014223 performed a study of a regularity-driven operation scheme in Stockholm, Sweden to improve reliability and mitigate bus bunching. Using a series of field experiments and measuring performance with regularity indicators such as headway coefficient of variation, headway adherence, and average excess waiting time, he determined that a headway-based control strategy was effective in not only narrowing the headway distribution from the previous schedule-bases strategy, but also reducing waiting times, more evenly distributing dwell times, and maintaining running times. @CHEN2012 also performed a headway-based study to measure the effects of real-time preventive operations control. They found that reliability is improved with lower permitted headway deviations and lower fluctuations of running times. When real-time information is used to predict service reliability and trigger preventive control, such as reduced dwell time and speed adjustments, bus bunching can be reduced.

Both of these studies effectively demonstrate that solutions to bunching and other reliability-based operational problems are most effectively addressed through reliability-based control strategies. However, little has been done to evaluate the relationship between methods of TSP in a reliability-based control strategy. A study of TSP strategies with a focus on headway distribution could prove useful in gauging the benefits of TSP in a headway-based system, such as the UVX BRT system in Utah Valley.  


## References
    

Al-Deek, H., Sandt, A., Alomari, A., Hussain, O. (2017). A technical note on evaluating the effectiveness of bus rapid transit with transit signal priority. Journal of Intelligent Transportation Systems, 21(3), 227-238. https://doi.org/10.1080/15472450.2017.1286987  

Cats, O. (2014). Regularity-driven bus operation: Principles, implementation and business models. Transport Policy, 36, 223-230. https://doi.org/10.1016/j.tranpol.2014.09.002  

Chen, W., Yang, C., Feng, F., Chen, Z. (2012). An Improved Model for Headway-Based Bus Service Unreliability Prevention with Vehicle Load Capacity Constraint at Bus Stops. Discrete Dynamics in Transportation Systems, 2012. https://doi.org/10.1155/2012/313518  

Delgado,F., Muñoz,J.C., Giesen,R., Wilson,N.H.M. (2015). Integrated Real-Time Transit Signal Priority Control for High-Frequency Segregated Transit Services.Transportation Research Record, 2533(1), 28-38. https://doi.org/10.3141/2533-04  

Ishaq, R., & Cats, O.(2020). Designing bus rapid transit systems:Lessons on service reliability and operations. Case Studies on Transport Policy, 8(3), 946-953. https://doi.org/10.1016/j.cstp.2020.05.001  

Liu, X.C., Zlatkovic, M., Porter, R.J., Fayyaz, K., Yu, S.(2018). Improving Efficiency and Reliability of Bus Rapid Transit, MPC-18-349. North Dakota State University -Upper Great Plains Transportation Institute, Fargo: Mountain-Plains Consortium, 2018.  

Ni, Y., Lo, H., Hsu, Y. (2020). Exploring the effects of passive transit signal priority design on bus rapid transit operation: a microsimulation-based optimization approach. Transportation Letters. https://doi.org/10.1080/19427867.2020.1805681  

Yang, M., Sun, G., Wang, W., Sun, X., Ding, J., & Han, J. (2018). Evaluation of the pre-detective signal priority for bus rapid transit: coordinating the primary and secondary intersections.Transport,33(1), 41-51. https://doi.org/10.3846/16484142.2015.1004556

<!--chapter:end:02-literature.Rmd-->

# Methods

We modified a dataset provided by Utah Transit Authority (UTA) to verify the affects of several TSP strategies on headway variation of the UVX BRT system. This BRT system is a 10 mile line between Provo and Orem and was open for public use as of January 9, 2019. The demographics of this area are particularly marked by the presence of two large universities in the area, Brigham Young University in Provo and Utah Valley University in Orem. With over 30,000 students in enrolled in each respective institution each year, a great deal of traffic demand is created between students traveling to and from school, especially considering the fact that housing and job demands are driven by students. For this reason there is a decent amount of UVU students who live in Provo, and the need to make the Provo-Orem commute causes considerable delay during peak hours. In conjunction with servicing other demographics of the population, servicing student needs was a large factor in the decision to implement a BRT system in this area.

## Data

We created an analysis dataset from UTA's raw dataset that included timepoint data for all UVX BRT trips from January 2, 2019 to December 30, 2019. The dataset was cleaned and reoriented to reflect data that would be useful in analyzing the distribution of headways over different times of day, locations, and TSP thresholds. We retained within the dataset routes, trips, stops, and vehicles. We simplified the format of these datapoints and created a new variable to hold information regarding reliability, or the difference between scheduled departures and actual departures. we also changed the level descriptions of the TSP thresholds.

```{r setup method, include = FALSE}
knitr::opts_chunk$set(cache = TRUE)
library(tidyverse)
library(readxl)
library(lubridate)
```

```{r load, echo = FALSE}
(df <- read_csv(
  "UVX_Reliability_2019.csv/UVX_Reliability_2019.csv",
  col_types = str_c(rep("c", 24), collapse = "")
  ))
```

```{r my_df, echo = FALSE}
# Where do you read and store the data?
# I added the code above that shows where my data is stored and where I read it from.
(df <- df %>%
  transmute(
    # Route and direction IDs
    route = Route, direction = substr(Direction, 0, 2), 
    trip = Trip,
    timepoint = `Time Point`,
    vehicle = Vehicle,
    
    # Time points
    date = as_date(mdy(NEW_Date)),
    time = as_datetime(str_c(mdy(NEW_Date), " ", DepartureTime)),
    schedule = as_datetime(str_c(mdy(NEW_Date), " ", Schedule, ":00")),
    reliability = time - schedule,
    dwell = as.difftime(str_c("00:", Dwell)),
    travel = as.difftime(Travel),
    
    # change level descriptions for TSP thresholds
    threshold = factor(Threshold, levels = c("OFF", "5", "2", "ON"), 
                       labels = c("No TSP", "5 min", "2 min", "Always"))
  ))
```

We also calculated elapsed headways, discrepancies between scheduled and actual headways, and cumulative dwell times on trips, as these are potential factors to verify the effects of manipulation on TSP thresholds.

```{r headway, echo = FALSE}
df <- df %>%
  group_by(direction, timepoint) %>%
  arrange(time, .by_group = TRUE) %>%
  mutate(
    hw_actl = time - lead(time),
    hw_schd = schedule - lead(schedule),
    discrepancy = hw_schd - hw_actl
  )
```

```{r cumdwell, echo = FALSE}
df <- df %>%
  group_by(direction, trip, date) %>%
  arrange(time, .by_group = TRUE) %>%
  mutate(
    cumdwell = cumsum(as.numeric(dwell))
  )
```

The team noticed some data integrity issues, particularly cases where large discrepancies between scheduled and actual headway were taking place. Those outliers can be seen below.

```{r hist-disc, echo = FALSE}
# why not create the figure here?
# I just needed to change eval = FALSE to echo = FALSE. Since R knits in a fresh session, the required inputs were not available to plot

df %>%
 ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]")
```

Investigation of these large discrepancies led the team to discover that they tended to occur at certain stops along the route, particularly at the Provo Frontrunner station, as well as at times early in the morning and late at night.

```{r large-discrepancy, echo = FALSE}
# find places where the discrepancy is large
(large_discrepancy <- df %>% ungroup() %>%
  arrange(-abs(discrepancy)) %>%
  filter(abs(discrepancy) >= 1000) %>%
  select(direction, trip, timepoint, time, discrepancy))

large_discrepancy %>% 
  group_by(timepoint) %>% 
  tally() %>% arrange(-n)

large_discrepancy %>% 
  group_by(trip) %>% 
  tally() %>% arrange(-n)
```

The distribution of discrepancies was shown to improve in normalcy with the omission of headways occurring before 7 PM and after 8 PM. Southbound trips at both the Provo Frontrunner 1 and Provo Frontrunner 2 stops were also omitted since the buses stop twice at the same location in the same direction.

```{r study-df, echo = FALSE}
study_df <- df %>%
  ungroup() %>%
  mutate(
    hour = lubridate::hour(time),
    weekday = lubridate::wday(time)
  ) %>%
  filter(
    !weekday %in% c("Saturday", "Sunday"),
    hour >= 7, hour <= 20
  )

study_df <- study_df[!(study_df$timepoint == "PROVFRST - 1" | study_df$timepoint == "PROVFRST - 2"),]
```

The cleaned dataset had a better distribution of headway discrepancies, as is seen below.

```{r hist-disc-study, echo = FALSE}
study_df %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]")
```

This data is ready for analysis of headway distributions based off of modifications to TSP strategies.

<!--chapter:end:03-method.Rmd-->

# Applications

```{r setup method 4, include = FALSE}
knitr::opts_chunk$set(cache = TRUE)
library(tidyverse)
library(readxl)
library(lubridate)
library(ANOVAreplication)
library(multcompView)
library(knitr)
```

The timepoint data was **previously analyzed** for headway distributions corresponding to the four separate TSP thresholds for the entire route and T-tests indicated that the means of the headway distributions were not significantly different. However, 
the distributions of the four thresholds were not the same. Further investigation of the data may explain differences that are seen between TSP thresholds but that do not significantly change the means of their respective distributions. To investigate the effects of TSP thresholds on headway reliability, a number of things can be done, including splitting up the routes by direction and location and performing additional statistical tests on the data to analyze for variation between groups. A preliminary analysis of the data split in that way is shown below.

## Grouped Distributions

A comparison of headway distributions for separate locations and directions of travel may be insightful into the effects of TSP at different points along the UVX route. For this purpose, the route has been partitioned into the following 12 groups. Groups were chosen to capture groups of riders from four separate sections of the route, as well as to address major intersections where TSP may have more of an influence in one of two directions. In order to provide better comparisons of NB and SB routes, the PROVO groups do not include the stops south of Provo Central Station, since they only appear in the SB trips.

|Group|Starting Station|Ending Station|Direction|Number of Stops|Length|
|----|-----------------|--------------|---------|---------------|------|
|UVU|Orem Central|Main Street|Both|4|2.50 miles|
|UVUNB|Main Street|Orem Central|NB|4|2.50 miles|
|UVUSB|Orem Central|Main Street|SB|4|2.50 miles|
|UNI|Main Street|Byu Stadium|Both|4|2.80 miles|
|UNINB|Byu Stadium|Main Street|NB|4|2.80 miles|
|UNISB|Main Street|Byu Stadium|SB|4|2.80 miles|
|BYU|Byu Stadium|Academy Square|Both|5|2.35 miles|
|BYUNB|Academy Square|Byu Stadium|NB|5|2.35 miles|
|BYUSB|Byu Stadium|Academy Square|SB|5|2.35 miles|
|PROVO|Academy Square|Provo Central|Both|5|1.85 miles|
|PROVONB|Provo Central|Academy Square|NB|5|1.85 miles|
|PROVOSB|Academy Square|Provo Central|SB|5|1.85 miles|

```{r load 4, echo = FALSE}
(df <- read_csv(
  "Data/UVX_Reliability_2019.csv/UVX_Reliability_2019.csv",
  col_types = str_c(rep("c", 24), collapse = "")
  ))
```

```{r my_df 4, echo = FALSE}
# Where do you read and store the data?
# I added the code above that shows where my data is stored and where I read it from.
(df <- df %>%
  transmute(
    # Route and direction IDs
    route = Route, direction = substr(Direction, 0, 2), 
    trip = Trip,
    timepoint = `Time Point`,
    vehicle = Vehicle,
    
    # Time points
    date = as_date(mdy(NEW_Date)),
    time = as_datetime(str_c(mdy(NEW_Date), " ", DepartureTime)),
    schedule = as_datetime(str_c(mdy(NEW_Date), " ", Schedule, ":00")),
    reliability = time - schedule,
    dwell = as.difftime(str_c("00:", Dwell)),
    travel = as.difftime(Travel),
    
    # change level descriptions for TSP thresholds
    threshold = factor(Threshold, levels = c("OFF", "5", "2", "ON"), 
                       labels = c("No TSP", "5 min", "2 min", "Always"))
  ))
```

We also calculated elapsed headways, discrepancies between scheduled and actual headways, and cumulative dwell times on trips, as these are potential factors to verify the effects of manipulation on TSP thresholds.

```{r headway 4, echo = FALSE}
df <- df %>%
  group_by(direction, timepoint) %>%
  arrange(time, .by_group = TRUE) %>%
  mutate(
    hw_actl = time - lead(time),
    hw_schd = schedule - lead(schedule),
    discrepancy = hw_schd - hw_actl
  )
```

```{r cumdwell 4, echo = FALSE}
df <- df %>%
  group_by(direction, trip, date) %>%
  arrange(time, .by_group = TRUE) %>%
  mutate(
    cumdwell = cumsum(as.numeric(dwell))
  )
```

```{r study-df 4, echo = FALSE}
study_df <- df %>%
  ungroup() %>%
  mutate(
    hour = lubridate::hour(time),
    weekday = lubridate::wday(time)
  ) %>%
  filter(
    !weekday %in% c("Saturday", "Sunday"),
    hour >= 7, hour <= 20
  )

study_df <- study_df[!(study_df$timepoint == "PROVFRST - 1" | study_df$timepoint == "PROVFRST - 2"),]
```

```{r grouped routes, echo = FALSE}

#Make timepoint data a factor
study_df$timepoint <- as.factor(study_df$timepoint)

#Create the UVU group from Orem Central to Main St
UVUvector <- c("OREMFRST", "UVU-CMPS", "LAKEVIEW", "MAIN--ST")
UVU <- study_df %>%
  filter(timepoint %in% UVUvector)

#Create UVU NB and UVU SB groups
UVUNB <- filter(UVU, direction == "NB")
UVUSB <- filter(UVU, direction == "SB")

#Create the UNI group from Main St to BYU Stadium
UNIvector <- c("MAIN--ST", "UNIVPLAC", "2230---N", "BYU-STAD")
UNI <- study_df %>%
  filter(timepoint %in% UNIvector)

#Create the UNI NB and SB groups
UNINB <- filter(UNI, direction == "NB")
UNISB <- filter(UNI, direction == "SB")

#Create the BYU group from BYU Stadium to Academy Square
BYUvector <- c("BYU-STAD", "BYU----N", "BYU-CMPS", "JOA-QUIN", "ACADSQUR")
BYU <- study_df %>%
  filter(timepoint %in% BYUvector)

#Create the BYU NB and SB groups
BYUNB <- filter(BYU, direction == "NB")
BYUSB <- filter(BYU, direction == "SB")

#Create the PROVO group from Academy Square to East Bay South
PROVOvector <- c("ACADSQUR", "300----N", "CNTR--ST", "400----S", "PROVFRST")
PROVO <- study_df %>%
  filter(timepoint %in% PROVOvector)

#Create the PROVO NB and SB groups
PROVONB <- filter(PROVO, direction == "NB")
PROVOSB <- filter(PROVO, direction == "SB")
```

Histograms for the separate groups will be created for initial visualization of the data, so as to inspect for differences among the groups. The first four histograms show the UVU, UNI, BYU, and PROVO groups, respectively. The second four histograms show the same groups for NB trips, and the last four show the same groups for the SB trips.

```{r group histograms, echo = FALSE}

#Create UVU histogram
UVU %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("UVU Route")

#Create UNI histogram
UNI %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("UNI Route")

#Create BYU histogram
BYU %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("BYU Route")

#Create PROVO histogram
PROVO %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("PROVO Route")

#Create UVUNB histogram
UVUNB %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("UVU NB Route")

#Create UNINB histogram
UNINB %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("UNI NB Route")

#Create BYUNB histogram
BYUNB %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("BYU NB Route")

#Create PROVONB histogram
PROVONB %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("PROVO NB Route")

#Create UVUSB histogram
UVUSB %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("UVU SB Route")

#Create UNISB histogram
UNISB %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("UNI SB Route")

#Create BYUSB histogram
BYUSB %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("BYU SB Route")

#Create PROVOSB histogram
PROVOSB %>%
  ungroup() %>%
  mutate(discrepancy = as.numeric(abs(discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = discrepancy / 60)) + # convert seconds to minutes
  geom_histogram() +
  scale_x_log10() +
  xlab("Absolute discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("PROVO SB Route")
```

Inspection of the histograms indicates that the distributions of headway discrepancies for the groups tends to be around 1 minute. There is some variation between the groups, though the distributions appear to be somewhat normal. A table of group means and standard deviations is given below.

```{r groups stats table, echo = FALSE}
#get the means and standard deviations for each group to display, and reorder according to route
Fullmeans <- aggregate(data = Fullroutes, Discrepancy ~ Route, FUN = mean)
a <- c("PROVO", "BYU", "UNI", "UVU")
Fullmeans <- Fullmeans %>%
  slice(match(a, Route))
NBmeans <-  aggregate(data = NBroutes, Discrepancy ~ Route, FUN = mean)
b <- c("PROVONB", "BYUNB", "UNINB", "UVUNB")
NBmeans <- NBmeans %>%
  slice(match(b, Route))
SBmeans <- aggregate(data = SBroutes, Discrepancy ~ Route, FUN = mean)
c <- c("PROVOSB", "BYUSB", "UNISB", "UVUSB")
SBmeans <- SBmeans %>%
  slice(match(c, Route))
Fullsd <- aggregate(data = Fullroutes, Discrepancy ~ Route, FUN = sd)
Fullsd <- Fullsd %>%
  slice(match(a, Route))
NBsd <- aggregate(data = NBroutes, Discrepancy ~ Route, FUN = sd)
NBsd <- NBsd %>%
  slice(match(b, Route))
SBsd <- aggregate(data = SBroutes, Discrepancy ~ Route, FUN = sd)
SBsd <- SBsd %>%
  slice(match(c, Route))

#Create a dataframe for the means and sd's of each group
Groupmeans <- as.data.frame(rbind(Fullmeans, NBmeans, SBmeans))
groupsds <- as.vector(c(Fullsd$Discrepancy, NBsd$Discrepancy, SBsd$Discrepancy))
Groupsummary <- cbind(Groupmeans, groupsds)
Groupsummary <- rename(Groupsummary, "Mean" = Discrepancy, "SD" = groupsds)

#create a nice table for the group summary
kable(Groupsummary)
```

The results of splitting up the trips by location are expected. There is not a large variation of discrepancies when routes are compared with both their northbound and southbound trips included. This is likely due to the trend seen in the northbound and southbound groups. The mean discrepancy increases in the northbound trips as the buses travel from the start of the trip in Provo towards the end of the trip near UVU. The same trend is seen in the southbound trips from UVU to Provo. The standard deviations of headway discrepancies behave the same way. This indicates the cumulative nature of headway discrepancy. As buses progress along their routes, irregularities tend to compound. This is may be due to problems such as the bunching phenomenon discussed in the literature.

The differences between these groups are difficult to determine visually, but statistical tests can help determine which if any differences are significant. To investigate whether there are differences between the groups, F-tests will be performed to determine if there are significant differences between any of groups. If significant differences are observed, then the Tukey-Kramer procedure for multiple comparisons of unplanned differences will be used to evaluate them.


## statistical Tests on Grouped Distributions

```{r groups df, echo = FALSE}
#Collect the discrepancy column from each group dataframe as a vector
UVUdisc <- as.vector(UVU$discrepancy)
UVUNBdisc <- as.vector(UVUNB$discrepancy)
UVUSBdisc <- as.vector(UVUSB$discrepancy)
UNIdisc <- as.vector(UNI$discrepancy)
UNINBdisc <- as.vector(UNINB$discrepancy)
UNISBdisc <- as.vector(UNISB$discrepancy)
BYUdisc <- as.vector(BYU$discrepancy)
BYUNBdisc <- as.vector(BYUNB$discrepancy)
BYUSBdisc <- as.vector(BYUSB$discrepancy)
PROVOdisc <- as.vector(PROVO$discrepancy)
PROVONBdisc <- as.vector(PROVONB$discrepancy)
PROVOSBdisc <- as.vector(PROVOSB$discrepancy)

#Create vectors for each of the factor levels (each of the 12 routes)

UVUroute <- rep("UVU", 190149)
UVUNBroute <- rep("UVUNB", 96854)
UVUSBroute <- rep("UVUSB", 93295)
UNIroute <- rep("UNI", 202718)
UNINBroute <- rep("UNINB", 100875)
UNISBroute <- rep("UNISB", 101843)
BYUroute <- rep("BYU", 253374)
BYUNBroute <- rep("BYUNB", 124976)
BYUSBroute <- rep("BYUSB", 128398)
PROVOroute <- rep("PROVO", 217793)
PROVONBroute <- rep("PROVONB", 115358)
PROVOSBroute <- rep("PROVOSB", 102435)
              
#combine vectors into dataframes for comparing discrepancies (1- compare full routes, 2- compare NB routes, 3- compare SB routes)

#Full routes dataframe
Fullroutes <- as.data.frame(cbind(c(UVUroute, UNIroute, BYUroute, PROVOroute), c(UVUdisc, UNIdisc, BYUdisc, PROVOdisc))) %>% 
  rename(Route = V1, Discrepancy = V2)
Fullroutes$Discrepancy <- as.numeric(Fullroutes$Discrepancy)
Fullroutes$Route <- as.factor(Fullroutes$Route)

#NB routes dataframe
NBroutes <- as.data.frame(cbind(c(UVUNBroute, UNINBroute, BYUNBroute, PROVONBroute), c(UVUNBdisc, UNINBdisc, BYUNBdisc, PROVONBdisc))) %>% 
  rename(Route = V1, Discrepancy = V2)
NBroutes$Discrepancy <- as.numeric(NBroutes$Discrepancy)
NBroutes$Route <- as.factor(NBroutes$Route)

#SB routes dataframe
SBroutes <- as.data.frame(cbind(c(UVUSBroute, UNISBroute, BYUSBroute, PROVOSBroute), c(UVUSBdisc, UNISBdisc, BYUSBdisc, PROVOSBdisc))) %>% 
  rename(Route = V1, Discrepancy = V2)
SBroutes$Discrepancy <- as.numeric(SBroutes$Discrepancy)
SBroutes$Route <- as.factor(SBroutes$Route)
```

```{r F- tests on group distributions, echo = FALSE}
#Create a model and perform the F test for the Fullroutes dataframe
Fullrouteslm <- lm(Discrepancy ~ Route, data = Fullroutes)
anova(Fullrouteslm)
#p-value of 0.884- no evidence of a difference

#Create a model and perform the F test for the NBroutes dataframe
NBrouteslm <- lm(Discrepancy ~ Route, data = NBroutes)
anova(NBrouteslm)
#p-value of 0.01114- moderate evidence of a difference

#Create a model and perform the F test for the SBroutes dataframe
SBrouteslm <- lm(Discrepancy ~ Route, data = SBroutes)
anova(SBrouteslm)
#p-value of 0.08066, suggestive but inconclusive evidence of a difference
```

The F-tests above indicate whether there are differences between mean headway discrepancies of the UVU, UNI, BYU, or PROVO groups when compared to their respective full, NB, or SB counterparts. The tests indicate that when comparing these four sections of the bus route, there is no evidence of a difference between the groups when both their NB and SB trips are combined (*p*-value = 0.884). There is moderate evidence of a difference between at least two of the NB groups (*p*-value = 0.01114). There is suggestive, but inconclusive evidence of a difference between at least two of the SB groups (*p*-value = 0.08066). The differences described here can be seen more clearly in comparative plots of the cumulative headway discrepancy, as shown below.

```{r cumulative headway discrepancy, echo = FALSE}
#Compare the Full routes
Fullroutes %>%
  ungroup() %>%
  mutate(Discrepancy = as.numeric(abs(Discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = Discrepancy / 60, color = Route)) + # convert seconds to minutes
  stat_ecdf() +
  scale_x_log10() +
  xlab("Cumulative discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("Full Routes")

#Compare the NB routes
NBroutes %>%
  ungroup() %>%
  mutate(Discrepancy = as.numeric(abs(Discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = Discrepancy / 60, color = Route)) + # convert seconds to minutes
  stat_ecdf() +
  scale_x_log10() +
  xlab("Cumulative discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("NB Routes")

#Compare the SB routes
SBroutes %>%
  ungroup() %>%
  mutate(Discrepancy = as.numeric(abs(Discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = Discrepancy / 60, color = Route)) + # convert seconds to minutes
  stat_ecdf() +
  scale_x_log10() +
  xlab("Cumulative discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("SB Routes")
```

It can easily be seen from the plots that in combining the NB and SB trips for each group (PROVO, BYU, UNI, or UVU), the discrepancies do not vary much, likely due to the opposite effect of compounding irregularities from the trip origin. However, there are some differences between the NB and SB groups that are worth noting. In the plot of the NB routes, there appears to be a fairly even distribution of headway discrepancies along the route. No one group appears to be more influential to the discrepancy, but the discrepancy does increase between all sections when buses travel from Provo to UVU. However, in the plot of the SB routes, the cumulative headway distribution varies less from between the UNI, BYU, and PROVO sections. This indicates that headway deviations are not particularly exacerbated during that portion of the bus trips. This could be due to lower demand in the SB trips past the BYU area, as much of the ridership is likely students traveling between BYU and UVU.

Estimates of the differences in mean headway discrepancy are provided by the Tukey-Kramer procedure for multiple comparisons. Because no significant differences were found for the groups including both NB and SB trips, no estimates for those groups are evaluated. Estimates of the differences for the NB groups and then the SB groups are provided below.

```{r Tukey on group distributions, echo = FALSE}
#Perform a Tukey-Kramer test of multiple comparisons on the NB routes
AOVNB <- aov(NBrouteslm)
TukeyNB <- TukeyHSD(AOVNB)
TukeyNB

#Perform a Tukey-Kramer test of multiple comparisons on the SB routes
AOVSB <- aov(SBrouteslm)
TukeySB <- TukeyHSD(AOVSB)
TukeySB
```
The adjusted *p*-values indicate the significance of differences between groups and, as expected, they are smallest for the sections that are furthest apart from each other (UVUNB-PROVONB and UVUSB-PROVOSB). It is estimated with 95% confidence that the headway discrepancy increases by 1.87 minutes between the PROVO section and the UVU section for NB buses. That difference is estimated as 1.62 minutes for SB traffic. The differences between each adjacent section are also provided above. It should be noted that the differences between PROVO and BYU are estimated with the opposite sign as the other differences due to the fact that it subtracts the northern section's mean from the southern section's mean, whereas all other relationships do the opposite.

These tests give us a glimpse of the differences in headway deviation by location, but further analysis will provide us a clearer idea of the differences at play with regards to TSP modifications.


## KS Tests on Grouped Distributions

The Kolmogorov-Smirnov test is a non-parametric test of probability distributions, and can be used with the given dataset to compare groups. We will first compare the cumulative distributions of headway discrepancy for the NB and SB trips, since differences based on direction have previously been identified. Plots of the NB and SB cumulative headway discrepancies are shown below.

```{r cumulative headway by direction, echo = FALSE}
#Show the cumulative distribution of the NB routes
NBroutes %>%
  ungroup() %>%
  mutate(Discrepancy = as.numeric(abs(Discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = Discrepancy / 60)) + # convert seconds to minutes
  stat_ecdf() +
  scale_x_log10() +
  xlab("Cumulative discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("NB Routes")

#Show the cumulative distribution of the SB routes
SBroutes %>%
  ungroup() %>%
  mutate(Discrepancy = as.numeric(abs(Discrepancy) + 1)) %>% # +1 for log(0)
  ggplot(aes(x = Discrepancy / 60)) + # convert seconds to minutes
  stat_ecdf() +
  scale_x_log10() +
  xlab("Cumulative discrepancy between scheduled and actual headways [minutes]") +
  ggtitle("SB Routes")
```


```{r KS tests, echo = FALSE}
#I am a little unsure of how to use the ks test. I want to show comparisons between the cumulative distributions of headways I believe.
#I am a little lost as to how to incorporate the TSP thresholds into my analysis.
#Below is a ks test comparing the NB cumulative distribution to he SB cumulative distribution
ks.test(NBroutes$Discrepancy, SBroutes$Discrepancy)
```
The test performed above compares the two cumulative distribution plots shown. The extremely small *p*-value of 2.2e-16 indicates with convincing evidence that the the NB discrepancies and SB discrepancies were not drawn from the same continuous distribution, and are significantly different.


**Further analysis needs to be done regarding TSP thresholds, since I was unsure of how to fit them into this analysis. I hope to meet with Dr. Macfarlane sometime this week to go over the work I've done and receive clarification on some tests so I can make the necessary modifications.**



<!--chapter:end:04-application.Rmd-->

# Final Words

We have finished a nice book.

<!--chapter:end:05-summary.Rmd-->

`r if (knitr::is_html_output()) '
# References {-}
'`

<!--chapter:end:06-references.Rmd-->

